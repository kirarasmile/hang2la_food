import{g as x,C as S,D as b,G as l,U as k,k as d,t as N,W as T,x as F,X as P,M as n,L as i,K as s,T as y,O as W,S as j}from"./index-DNtBY2Q3.js";import{A as E}from"./index-DEV-fsYM.js";import{a as G,F as V}from"./useFilter-TibTqSy1.js";import{T as p,a as M}from"./index-BnxkOLea.js";import{A as q}from"./ArrowBackOutline-Dw73vaex.js";import{u as z,N as C,_ as L}from"./_plugin-vue_export-helper-BkxoI2SV.js";import"./Checkbox-BIgRpK8s.js";import"./RadioGroup-DCfzLR2M.js";const U={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},H=l("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),J=l("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1),K=[H,J],X=x({name:"RefreshOutline",render:function(f,B){return b(),S("svg",U,K)}}),Z={class:"map-page"},Q={class:"page-header"},Y={class:"filter-wrapper"},ee=x({__name:"MapPage",setup(A){const f=j(),B=z(),a=k(null),o=k(null),c=d([]),u=d([]),m=d(!1),_=[{id:"1",name:"海底捞火锅",tier:"hang",category:"hotpot",price_per_person:120,address:"上海市黄浦区南京东路123号",city:"上海",latitude:31.235929,longitude:121.485708,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1},{id:"5",name:"星巴克",tier:"elite",category:"drinks",price_per_person:40,address:"北京市朝阳区建国门外大街1号",city:"北京",latitude:39.908718,longitude:116.453472,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1}],{filteredRestaurants:v}=G(u);N(async()=>{await w(),await I()}),T(()=>{a.value&&a.value.destroy()}),F(v,()=>{g()},{deep:!0});async function w(){m.value=!0;try{const{data:e,error:t}=await P.from("restaurants").select("*").eq("is_deleted",!1);if(t)throw t;e&&e.length>0?u.value=e:u.value=_}catch(e){console.warn("Fetch from Supabase failed, using mock data:",e.message),u.value=_}finally{m.value=!1}}async function I(){try{const e="4c07c0ea7823f62a296cf8fe1c63a051",t="5ed5a6f819b34660b9145bf5490ea565";t&&(window._AMapSecurityConfig={securityJsCode:t}),o.value=await E.load({key:e,version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation"]}),a.value=new o.value.Map("map-container",{viewMode:"3D",zoom:11,center:[121.4737,31.2304],theme:"amap://styles/dark"}),a.value.addControl(new o.value.ToolBar),a.value.addControl(new o.value.Scale);const r=new o.value.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB"});a.value.addControl(r),r.getCurrentPosition((D,h)=>{D==="complete"&&(a.value.setCenter([h.position.lng,h.position.lat]),a.value.setZoom(15))}),g()}catch(e){console.error("Map init failed",e)}}function g(){!a.value||!o.value||(c.value.forEach(e=>e.setMap(null)),c.value=[],v.value.forEach(e=>{if(e.longitude&&e.latitude){const t=p[e.tier],r=new o.value.Marker({position:[e.longitude,e.latitude],title:e.name,content:$(t.emoji,t.color),offset:new o.value.Pixel(-15,-15)});r.on("click",()=>{O(e)}),r.setMap(a.value),c.value.push(r)}}),c.value.length>0&&a.value.setFitView())}function $(e,t){return`<div class="custom-marker" style="background-color: ${t}">
    <span class="marker-emoji">${e}</span>
  </div>`}function O(e){const t=`
    <div class="info-window">
      <h4>${e.name}</h4>
      <p>评级: ${p[e.tier].emoji} ${p[e.tier].label}</p>
      <p>价格: ¥${e.price_per_person}/人</p>
      <p>地址: ${e.address}</p>
    </div>
  `;new o.value.InfoWindow({content:t,offset:new o.value.Pixel(0,-30)}).open(a.value,[e.longitude,e.latitude])}function R(){f.push("/")}return(e,t)=>(b(),S("div",Z,[l("header",Q,[n(s(C),{align:"center"},{default:i(()=>[n(s(y),{quaternary:"",circle:"",onClick:R},{icon:i(()=>[n(s(M),null,{default:i(()=>[n(s(q))]),_:1})]),_:1}),t[0]||(t[0]=l("h1",{class:"page-title"},"美食地图",-1))]),_:1}),n(s(C),null,{default:i(()=>[n(s(y),{secondary:"",onClick:w},{icon:i(()=>[n(s(M),null,{default:i(()=>[n(s(X))]),_:1})]),default:i(()=>[t[1]||(t[1]=W(" 刷新数据 ",-1))]),_:1})]),_:1})]),l("div",Y,[n(V)]),t[2]||(t[2]=l("div",{id:"map-container",class:"map-container"},null,-1))]))}}),ce=L(ee,[["__scopeId","data-v-b00ea05f"]]);export{ce as default};
