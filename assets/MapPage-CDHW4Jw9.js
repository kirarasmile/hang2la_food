import{g as b,C as _,D as g,U as H,G as s,W as D,k as f,t as U,X as J,x as j,Y as K,M as a,L as l,K as n,I as M,H as X,Z as Y,_ as Z,T as C,O as P,S as Q}from"./index-CK7zZWCT.js";import{A as ee,N as te}from"./index-CaZRejZW.js";import{a as oe,F as ae}from"./useFilter-mRewkFFH.js";import{a as x,T as S}from"./index-B3ikh81R.js";import{A as ne}from"./ArrowBackOutline-DFTVPVe7.js";import{u as re,N as V,_ as ie}from"./_plugin-vue_export-helper-sXOk6YIR.js";import"./Checkbox-DQKgHmlJ.js";import"./RadioGroup-Bs7lOli6.js";const le={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},se=H('<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M256 96V56"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M256 456v-40"></path><path d="M256 112a144 144 0 1 0 144 144a144 144 0 0 0-144-144z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M416 256h40"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M56 256h40"></path>',5),ue=[se],ce=b({name:"LocateOutline",render:function(k,$){return g(),_("svg",le,ue)}}),de={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},pe=s("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),fe=s("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1),ve=[pe,fe],he=b({name:"RefreshOutline",render:function(k,$){return g(),_("svg",de,ve)}}),me={class:"map-page"},we={class:"page-header"},_e={class:"filter-wrapper"},ge={class:"viewport-info"},ke={class:"map-wrapper"},ye={key:0,class:"map-loading"},Me={id:"map-container",class:"map-container"},Ce=b({__name:"MapPage",setup(B){const k=Q(),$=re(),o=D(null),r=D(null),y=f([]),h=f(!1),d=f(!0),u=f([]),m=f([]),N=f(!1),A=[{id:"1",name:"海底捞火锅",tier:"hang",category:"hotpot",price_per_person:120,address:"上海市黄浦区南京东路123号",city:"上海",latitude:31.235929,longitude:121.485708,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1},{id:"5",name:"星巴克",tier:"elite",category:"drinks",price_per_person:40,address:"北京市朝阳区建国门外大街1号",city:"北京",latitude:39.908718,longitude:116.453472,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1}],{filteredRestaurants:p}=oe(m);U(async()=>{await I(),await F()}),J(()=>{o.value&&o.value.destroy()}),j(p,()=>{v()},{deep:!0}),j(u,()=>{E()},{deep:!0});async function I(){N.value=!0;try{const{data:e,error:t}=await K.from("restaurants").select("*").eq("is_deleted",!1);if(t)throw t;e&&e.length>0?m.value=e:m.value=A}catch(e){console.warn("Fetch from Supabase failed, using mock data:",e.message),m.value=A}finally{N.value=!1}}async function F(){try{const e="4c07c0ea7823f62a296cf8fe1c63a051",t="5ed5a6f819b34660b9145bf5490ea565";t&&(window._AMapSecurityConfig={securityJsCode:t}),r.value=await ee.load({key:e,version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation"]});const i=new r.value.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB"}),w=await new Promise(O=>{i.getCurrentPosition((q,R)=>{O(q==="complete"?{lng:R.position.lng,lat:R.position.lat}:null)})}),L=w?[w.lng,w.lat]:[121.4737,31.2304];o.value=new r.value.Map("map-container",{viewMode:"3D",zoom:w?15:11,center:L,theme:"amap://styles/dark"}),o.value.addControl(new r.value.ToolBar),o.value.addControl(new r.value.Scale),o.value.addControl(i),o.value.on("moveend",()=>{v()}),o.value.on("zoomend",()=>{v()}),h.value=!0,v()}catch(e){console.error("Map init failed",e),h.value=!0}}function v(){if(!o.value||!d.value){u.value=p.value;return}const e=o.value.getBounds();if(!e){u.value=p.value;return}const t=e.getNorthEast(),i=e.getSouthWest();u.value=p.value.filter(c=>!c.longitude||!c.latitude?!1:c.longitude>=i.lng&&c.longitude<=t.lng&&c.latitude>=i.lat&&c.latitude<=t.lat)}function T(){d.value=!d.value,d.value?v():u.value=p.value}function E(){!o.value||!r.value||(y.value.forEach(e=>e.setMap(null)),y.value=[],u.value.forEach(e=>{if(e.longitude&&e.latitude){const t=S[e.tier],i=new r.value.Marker({position:[e.longitude,e.latitude],title:e.name,content:W(t.emoji,t.color),offset:new r.value.Pixel(-15,-15)});i.on("click",()=>{z(e)}),i.setMap(o.value),y.value.push(i)}}))}function W(e,t){return`<div class="custom-marker" style="background-color: ${t}">
    <span class="marker-emoji">${e}</span>
  </div>`}function z(e){const t=`
    <div class="info-window">
      <h4>${e.name}</h4>
      <p>评级: ${S[e.tier].emoji} ${S[e.tier].label}</p>
      <p>价格: ¥${e.price_per_person}/人</p>
      <p>地址: ${e.address}</p>
    </div>
  `;new r.value.InfoWindow({content:t,offset:new r.value.Pixel(0,-30)}).open(o.value,[e.longitude,e.latitude])}function G(){k.push("/")}return(e,t)=>(g(),_("div",me,[s("header",we,[a(n(V),{align:"center"},{default:l(()=>[a(n(C),{quaternary:"",circle:"",onClick:G},{icon:l(()=>[a(n(x),null,{default:l(()=>[a(n(ne))]),_:1})]),_:1}),t[0]||(t[0]=s("h1",{class:"page-title"},"美食地图",-1))]),_:1}),a(n(V),null,{default:l(()=>[a(n(C),{type:d.value?"primary":"default",secondary:"",onClick:T},{icon:l(()=>[a(n(x),null,{default:l(()=>[a(n(ce))]),_:1})]),default:l(()=>[P(" "+M(d.value?"视野联动开":"视野联动关"),1)]),_:1},8,["type"]),a(n(C),{secondary:"",onClick:I},{icon:l(()=>[a(n(x),null,{default:l(()=>[a(n(he))]),_:1})]),default:l(()=>[t[1]||(t[1]=P(" 刷新数据 ",-1))]),_:1})]),_:1})]),s("div",_e,[a(ae),s("div",ge," 当前视野: "+M(u.value.length)+" / "+M(n(p).length)+" 家餐厅 ",1)]),s("div",ke,[h.value?X("",!0):(g(),_("div",ye,[a(n(te),{size:"large",description:"正在定位中..."})])),Y(s("div",Me,null,512),[[Z,h.value]])])]))}}),Oe=ie(Ce,[["__scopeId","data-v-422495b0"]]);export{Oe as default};
