import{g as D,T as b,k as p,t as R,U as O,x as T,P as F,C as P,G as c,J as o,K as l,N as n,D as E,S as f,R as G,Q as C}from"./index-Cm_SX6ap.js";import{A as V,T as m,a as v}from"./index-TCizGd1Y.js";import{a as W,F as j}from"./useFilter-Bm1dL8-y.js";import{i as S,o as q,c as z}from"./navigation-DUNkFvzQ.js";import{A as J}from"./ArrowBackOutline-BNMzSFXY.js";import{D as U,R as H}from"./RefreshOutline-IlBicHTy.js";import{u as K,N as A,_ as L}from"./_plugin-vue_export-helper-BVV14t8g.js";import"./Checkbox-8RZ3_wqu.js";import"./RadioGroup-BOx8ROlR.js";const Q={class:"map-page"},Z={class:"page-header"},X={class:"filter-wrapper"},Y=D({__name:"MapPage",setup(ee){const g=G(),$=K();window.handleMapNavigate=(e,a,s)=>{S()?q(e,a,s):z(e).then(d=>{d&&$.success("地址已复制")})};const t=b(null),i=b(null),r=p([]),u=p([]),w=p(!1),_=[{id:"1",name:"海底捞火锅",tier:"hang",category:"hotpot",price_per_person:120,address:"上海市黄浦区南京东路123号",city:"上海",latitude:31.235929,longitude:121.485708,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1},{id:"5",name:"星巴克",tier:"elite",category:"drinks",price_per_person:40,address:"北京市朝阳区建国门外大街1号",city:"北京",latitude:39.908718,longitude:116.453472,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1}],{filteredRestaurants:h}=W(u);R(async()=>{await y(),await x()}),O(()=>{t.value&&t.value.destroy()}),T(h,()=>{k()},{deep:!0});async function y(){w.value=!0;try{const{data:e,error:a}=await F.from("restaurants").select("*").eq("is_deleted",!1);if(a)throw a;e&&e.length>0?u.value=e:u.value=_}catch(e){console.warn("Fetch from Supabase failed, using mock data:",e.message),u.value=_}finally{w.value=!1}}async function x(){try{const e="4c07c0ea7823f62a296cf8fe1c63a051",a="5ed5a6f819b34660b9145bf5490ea565";a&&(window._AMapSecurityConfig={securityJsCode:a}),i.value=await V.load({key:e,version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation"]}),t.value=new i.value.Map("map-container",{viewMode:"3D",zoom:11,center:[121.4737,31.2304],theme:"amap://styles/dark"}),t.value.addControl(new i.value.ToolBar),t.value.addControl(new i.value.Scale);const s=new i.value.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB"});t.value.addControl(s),s.getCurrentPosition((d,M)=>{d==="complete"&&(t.value.setCenter([M.position.lng,M.position.lat]),t.value.setZoom(15))}),k()}catch(e){console.error("Map init failed",e)}}function k(){!t.value||!i.value||(r.value.forEach(e=>e.setMap(null)),r.value=[],h.value.forEach(e=>{if(e.longitude&&e.latitude){const a=m[e.tier],s=new i.value.Marker({position:[e.longitude,e.latitude],title:e.name,content:B(a.emoji,a.color),offset:new i.value.Pixel(-15,-15)});s.on("click",()=>{I(e)}),s.setMap(t.value),r.value.push(s)}}),r.value.length>0&&t.value.setFitView())}function B(e,a){return`<div class="custom-marker" style="background-color: ${a}">
    <span class="marker-emoji">${e}</span>
  </div>`}function I(e){const a=`
    <div class="info-window">
      <h4>${e.name}</h4>
      <p>评级: ${m[e.tier].emoji} ${m[e.tier].label}</p>
      <p>价格: ¥${e.price_per_person}/人</p>
      <p>地址: ${e.address}</p>
      <button 
        onclick="window.handleMapNavigate('${e.address}', ${e.latitude}, ${e.longitude})"
        style="margin-top: 8px; width: 100%; padding: 6px; background: #18a058; color: white; border: none; border-radius: 4px; cursor: pointer;"
      >
        ${S()?"开始导航":"复制地址"}
      </button>
    </div>
  `;new i.value.InfoWindow({content:a,offset:new i.value.Pixel(0,-30)}).open(t.value,[e.longitude,e.latitude])}function N(){g.push("/")}return(e,a)=>(E(),P("div",Q,[c("header",Z,[o(n(A),{align:"center"},{default:l(()=>[o(n(f),{quaternary:"",circle:"",onClick:N},{icon:l(()=>[o(n(v),null,{default:l(()=>[o(n(J))]),_:1})]),_:1}),a[1]||(a[1]=c("h1",{class:"page-title"},"美食地图",-1))]),_:1}),o(n(A),null,{default:l(()=>[o(n(f),{secondary:"",onClick:a[0]||(a[0]=s=>n(g).push("/random"))},{icon:l(()=>[o(n(v),null,{default:l(()=>[o(n(U))]),_:1})]),default:l(()=>[a[2]||(a[2]=C(" 随机选餐 ",-1))]),_:1}),o(n(f),{secondary:"",onClick:y},{icon:l(()=>[o(n(v),null,{default:l(()=>[o(n(H))]),_:1})]),default:l(()=>[a[3]||(a[3]=C(" 刷新数据 ",-1))]),_:1})]),_:1})]),c("div",X,[o(j)]),a[4]||(a[4]=c("div",{id:"map-container",class:"map-container"},null,-1))]))}}),ce=L(Y,[["__scopeId","data-v-0e22f5a6"]]);export{ce as default};
