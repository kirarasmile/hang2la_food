import{g as S,C as _,D as g,U as H,G as c,W as D,k as v,t as U,X as J,x as V,Y as K,M as n,L as i,K as l,I as M,H as X,Z as Y,_ as Z,T as C,O as j,S as Q}from"./index-ChtlSxlN.js";import{A as ee,N as te}from"./index-Dt3XrjT7.js";import{a as ae,F as oe}from"./useFilter-CqjHl6BH.js";import{a as x,T as N}from"./index-BI6IjMO1.js";import{A as ne}from"./ArrowBackOutline-j75XRqCF.js";import{u as le,N as P,_ as re}from"./_plugin-vue_export-helper-Xb4DSPjn.js";import"./Checkbox-C6Arrw5G.js";import"./RadioGroup--c0U83Rc.js";const ie={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},se=H('<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M256 96V56"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M256 456v-40"></path><path d="M256 112a144 144 0 1 0 144 144a144 144 0 0 0-144-144z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M416 256h40"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M56 256h40"></path>',5),ue=[se],ce=S({name:"LocateOutline",render:function(k,$){return g(),_("svg",ie,ue)}}),de={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},pe=c("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),fe=c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1),ve=[pe,fe],he=S({name:"RefreshOutline",render:function(k,$){return g(),_("svg",de,ve)}}),we={class:"map-page"},me={class:"page-header"},_e={class:"filter-wrapper"},ge={class:"viewport-info"},ke={class:"map-wrapper"},ye={key:0,class:"map-loading"},Me={id:"map-container",class:"map-container"},Ce=S({__name:"MapPage",setup(B){const k=Q(),$=le(),a=D(null),r=D(null),y=v([]),p=v(!1),f=v(!0),s=v([]),w=v([]),b=v(!1),A=[{id:"1",name:"海底捞火锅",tier:"hang",category:"hotpot",price_per_person:120,address:"上海市黄浦区南京东路123号",city:"上海",latitude:31.235929,longitude:121.485708,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1},{id:"5",name:"星巴克",tier:"elite",category:"drinks",price_per_person:40,address:"北京市朝阳区建国门外大街1号",city:"北京",latitude:39.908718,longitude:116.453472,created_by:"demo",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_deleted:!1}],{filteredRestaurants:u}=ae(w);U(async()=>{await I(),await F()}),J(()=>{a.value&&a.value.destroy()}),V(u,()=>{p.value&&h()},{deep:!0}),V(s,()=>{E()},{deep:!0});async function I(){b.value=!0;try{const{data:e,error:t}=await K.from("restaurants").select("*").eq("is_deleted",!1);if(t)throw t;e&&e.length>0?w.value=e:w.value=A}catch(e){console.warn("Fetch from Supabase failed, using mock data:",e.message),w.value=A}finally{b.value=!1}}async function F(){try{const e="4c07c0ea7823f62a296cf8fe1c63a051",t="5ed5a6f819b34660b9145bf5490ea565";t&&(window._AMapSecurityConfig={securityJsCode:t}),r.value=await ee.load({key:e,version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation"]});const o=new r.value.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB"}),m=await new Promise(O=>{o.getCurrentPosition((q,R)=>{O(q==="complete"?{lng:R.position.lng,lat:R.position.lat}:null)})}),L=m?[m.lng,m.lat]:[121.4737,31.2304];a.value=new r.value.Map("map-container",{viewMode:"3D",zoom:m?15:11,center:L,theme:"amap://styles/dark"}),a.value.addControl(new r.value.ToolBar),a.value.addControl(new r.value.Scale),a.value.addControl(o),a.value.on("moveend",()=>{h()}),a.value.on("zoomend",()=>{h()}),p.value=!0,h()}catch(e){console.error("Map init failed",e),p.value=!0}}function h(){if(!p.value||!a.value||!f.value){s.value=u.value;return}try{const e=a.value.getBounds();if(!e){s.value=u.value;return}const t=e.getNorthEast(),o=e.getSouthWest();if(!t||!o||isNaN(t.lng)||isNaN(t.lat)||isNaN(o.lng)||isNaN(o.lat)){s.value=u.value;return}s.value=u.value.filter(d=>!d.longitude||!d.latitude?!1:d.longitude>=o.lng&&d.longitude<=t.lng&&d.latitude>=o.lat&&d.latitude<=t.lat)}catch(e){console.warn("filterByViewport error:",e),s.value=u.value}}function T(){f.value=!f.value,f.value?h():s.value=u.value}function E(){!a.value||!r.value||(y.value.forEach(e=>e.setMap(null)),y.value=[],s.value.forEach(e=>{if(e.longitude&&e.latitude){const t=N[e.tier],o=new r.value.Marker({position:[e.longitude,e.latitude],title:e.name,content:W(t.emoji,t.color),offset:new r.value.Pixel(-15,-15)});o.on("click",()=>{z(e)}),o.setMap(a.value),y.value.push(o)}}))}function W(e,t){return`<div class="custom-marker" style="background-color: ${t}">
    <span class="marker-emoji">${e}</span>
  </div>`}function z(e){const t=`
    <div class="info-window">
      <h4>${e.name}</h4>
      <p>评级: ${N[e.tier].emoji} ${N[e.tier].label}</p>
      <p>价格: ¥${e.price_per_person}/人</p>
      <p>地址: ${e.address}</p>
    </div>
  `;new r.value.InfoWindow({content:t,offset:new r.value.Pixel(0,-30)}).open(a.value,[e.longitude,e.latitude])}function G(){k.push("/")}return(e,t)=>(g(),_("div",we,[c("header",me,[n(l(P),{align:"center"},{default:i(()=>[n(l(C),{quaternary:"",circle:"",onClick:G},{icon:i(()=>[n(l(x),null,{default:i(()=>[n(l(ne))]),_:1})]),_:1}),t[0]||(t[0]=c("h1",{class:"page-title"},"美食地图",-1))]),_:1}),n(l(P),null,{default:i(()=>[n(l(C),{type:f.value?"primary":"default",secondary:"",onClick:T},{icon:i(()=>[n(l(x),null,{default:i(()=>[n(l(ce))]),_:1})]),default:i(()=>[j(" "+M(f.value?"视野联动开":"视野联动关"),1)]),_:1},8,["type"]),n(l(C),{secondary:"",onClick:I},{icon:i(()=>[n(l(x),null,{default:i(()=>[n(l(he))]),_:1})]),default:i(()=>[t[1]||(t[1]=j(" 刷新数据 ",-1))]),_:1})]),_:1})]),c("div",_e,[n(oe),c("div",ge," 当前视野: "+M(s.value.length)+" / "+M(l(u).length)+" 家餐厅 ",1)]),c("div",ke,[p.value?X("",!0):(g(),_("div",ye,[n(l(te),{size:"large",description:"正在定位中..."})])),Y(c("div",Me,null,512),[[Z,p.value]])])]))}}),Oe=re(Ce,[["__scopeId","data-v-1fea200a"]]);export{Oe as default};
